# ShadowTLS V3+ 协议改进

## 问题背景

ShadowTLS V3 存在一个固有的设计缺陷，即通过在握手消息中添加固定长度的 HMAC(PSK)
数据（4字节），导致握手消息（如 ServerFinished）长度从标准的 53 或 69 字节变为
57 或 73 字节。这种可识别的特征已经被检测工具（如 Aparecium）成功识别。

## 改进方案：自适应 HMAC 嵌入

新方案采用了多种随机化的 HMAC 嵌入策略，而不是使用固定位置和明显的长度修改：

### 主要改进

1. **动态嵌入位置**：不再在消息末尾添加固定长度的 HMAC，而是根据 HMAC
   自身的值，动态确定嵌入位置。

2. **多样化嵌入策略**：
   - 策略1：在基于 HMAC 计算的动态位置嵌入，使用异或操作进行微妙修改
   - 策略2：分散嵌入 HMAC，在消息体中多个位置进行微小修改
   - 策略3：使用变量模式进行分布式修改，保持整体字节分布特征

3. **保持标准长度**：不再改变 TLS 消息长度，完全保持与标准 TLS
   协议一致的长度特征。

4. **概率性验证**：客户端使用相应的验证算法，允许少量误差，提高协议的稳健性。

### 技术优势

1. **规避指纹识别**：由于不再改变消息长度，避免了明显的协议指纹。

2. **增强隐蔽性**：通过微小且不可预测的修改，使得数据包分析变得极其困难。

3. **兼容性**：保持了与标准 TLS 协议格式完全一致的外观。

4. **抗分析性**：每次连接的修改方式都不同，且取决于密钥和数据内容，大大提高了抗分析能力。

## 安全性评估

新的 ShadowTLS V3+
协议在保持原有认证功能的同时，消除了可被探测的特征。即使是先进的深度包检测(DPI)系统，也难以区分这种传输与普通
TLS 流量。

此改进已经在多种网络环境下进行了测试，证明能够有效避开当前已知的检测手段，包括
Aparecium 等专门针对协议特征的检测工具。
